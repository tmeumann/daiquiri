FROM rust:latest

RUN apt update \
    && DEBIAN_FRONTEND=noninteractive apt -y install build-essential ssh gdbserver cmake rsync \
    && apt clean

RUN git clone --depth 1 --branch v2.0.0 https://github.com/google/flatbuffers.git \
    && cd flatbuffers \
    && cmake -G "Unix Makefiles" -DCMAKE_BUILD_TYPE=Release \
    && make \
    && make install \
    && cd .. \
    && rm -rf flatbuffers

WORKDIR /pdna

COPY PowerDNA_Linux_4.10.1.14.tgz /pdna/
RUN tar xzf PowerDNA_Linux_4.10.1.14.tgz \
    && cd /pdna/PowerDNA_4.10.1/src \
    && make \
    && make install

RUN mkdir /etc/daiquiri && ln -s /app/streams.json /etc/daiquiri/streams.json

VOLUME /app

WORKDIR /app

EXPOSE 3030 5555 1234

CMD ["bash"]
